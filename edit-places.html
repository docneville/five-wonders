<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Edit Places – Five Wonders</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root { color-scheme: light; font-size: 16px; }
    @media (max-width: 768px) { :root { font-size: 18px; } }

    * { box-sizing: border-box; }

    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #111827;
      background: #ffffff;
    }

    .fw-header {
      height: 48px;
      background: #111827;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      font-size: 14px;
      box-sizing: border-box;
    }

    .fw-header-title {
      font-weight: 600;
      color: #e5e7eb;
      letter-spacing: 0.02em;
      text-transform: none;
      font-size: 14px;
    }

    .fw-header-nav a {
      color: #9ca3af;
      text-decoration: none;
      font-size: 13px;
      margin-left: 10px;
    }

    .fw-header-nav a:first-child { margin-left: 0; }

    .fw-header-nav a:hover {
      color: #e5e7eb;
      text-decoration: underline;
    }

    #app {
      display: grid;
      grid-template-columns: 340px 1fr;
      grid-template-rows: 48px 1fr;
      grid-template-areas:
        "header header"
        "sidebar main";
      height: 100%;
      min-height: 0;
    }

    header.fw-header { grid-area: header; }

    #sidebar {
      grid-area: sidebar;
      border-right: 1px solid #e5e7eb;
      padding: 12px;
      overflow-y: auto;
      min-height: 0;
      background: #ffffff;
    }

    #main {
      grid-area: main;
      padding: 16px 18px;
      overflow-y: auto;
      min-height: 0;
      background: #ffffff;
    }

    .token-warning {
      font-size: 0.9rem;
      color: #92400e;
      background: #fef3c7;
      border: 1px solid #facc15;
      border-radius: 10px;
      padding: 10px 12px;
      margin-bottom: 10px;
    }

    .small-help {
      font-size: 0.85rem;
      color: #6b7280;
    }

    .section-title {
      font-size: 0.95rem;
      font-weight: 700;
      margin: 10px 0 6px;
      color: #111827;
    }

    .place-list {
      margin-top: 8px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      overflow: hidden;
      background: #ffffff;
    }

    .place-row {
      padding: 10px 12px;
      font-size: 0.95rem;
      border-bottom: 1px solid #f3f4f6;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 4px;
      background: #ffffff;
      color: #111827;
    }

    .place-row:last-child { border-bottom: none; }

    .place-row:hover { background: #f3f4f6; }
    .place-row.active { background: #dbeafe; }

    .place-row-title { font-weight: 600; }

    .place-row-note {
      font-size: 0.85rem;
      color: #6b7280;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #111827;
      background: #f3f4f6;
      margin-bottom: 10px;
    }

    h1 {
      font-size: 1.25rem;
      margin: 4px 0 8px;
      color: #111827;
    }

    label {
      font-size: 0.9rem;
      font-weight: 600;
      display: block;
      margin-top: 10px;
      margin-bottom: 6px;
      color: #374151;
    }

    input[type="text"],
    textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 1rem;
      font-family: inherit;
      background: #ffffff;
      color: #111827;
    }

    textarea { resize: vertical; min-height: 90px; }

    .row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 10px;
      font-size: 0.85rem;
      color: #6b7280;
    }

    button {
      border-radius: 12px;
      border: none;
      padding: 10px 12px;
      font-size: 1rem;
      cursor: pointer;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      min-height: 44px;
    }

    .btn-primary { background: #111827; color: #ffffff; }
    .btn-primary:hover { background: #0b1220; }

    .btn-danger { background: #ef4444; color: #fff; }
    .btn-danger:hover { background: #dc2626; }

    .btn-ghost {
      background: #e5e7eb;
      color: #111827;
      font-weight: 700;
    }

    .btn-ghost:hover { background: #d1d5db; }

    .actions {
      margin-top: 14px;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .status-msg {
      font-size: 0.9rem;
      color: #6b7280;
      margin-top: 8px;
    }

    .empty-state {
      font-size: 0.95rem;
      color: #6b7280;
      margin-top: 12px;
    }

    @media (max-width: 768px) {
      #app {
        grid-template-columns: 1fr;
        grid-template-rows: 48px 1fr;
        grid-template-areas:
          "header"
          "sidebar";
      }
      #main { display: none; }
    }

    .fw-fab {
      display: none;
      position: fixed;
      right: 16px;
      bottom: calc(16px + env(safe-area-inset-bottom));
      padding: 12px 14px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.15);
      background: white;
      font-size: 1rem;
      font-weight: 800;
      box-shadow: 0 10px 24px rgba(0,0,0,0.18);
      z-index: 2100;
      min-height: 44px;
      align-items: center;
      justify-content: center;
    }

    @media (max-width: 768px) {
      .fw-fab { display: inline-flex; }
    }

    .fw-sheet {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      height: 82vh;
      background: #fff;
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
      box-shadow: 0 14px 40px rgba(0,0,0,0.25);
      transform: translateY(100%);
      transition: transform 180ms ease;
      z-index: 2200;
      border-top: 1px solid rgba(0,0,0,0.12);
    }

    .fw-sheet--open { transform: translateY(0); }
    .fw-sheet--peek { transform: translateY(55%); }
    .fw-sheet--hidden { transform: translateY(100%); }

    .fw-sheet-handle {
      width: 44px;
      height: 5px;
      border-radius: 999px;
      background: rgba(0,0,0,0.25);
      margin: 10px auto 6px;
    }

    .fw-sheet-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      border-bottom: 1px solid rgba(0,0,0,0.10);
    }

    .fw-sheet-title {
      font-weight: 800;
      font-size: 1.05rem;
    }

    .fw-sheet-close {
      border: none;
      background: transparent;
      font-size: 1.3rem;
      padding: 8px;
      min-height: 44px;
      min-width: 44px;
      cursor: pointer;
    }

    .fw-sheet-content {
      padding: 12px 14px;
      overflow: auto;
      height: calc(82vh - 64px);
      box-sizing: border-box;
      padding-bottom: calc(110px + env(safe-area-inset-bottom));
    }

    .action-row {
      position: sticky;
      bottom: 0;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 10px;

      padding: 12px 14px calc(12px + env(safe-area-inset-bottom));
      margin-top: 16px;

      background: white;
      border-top: 1px solid rgba(0,0,0,0.12);
      z-index: 10;
    }

    .action-row .btn-primary,
    .action-row .btn-danger,
    .action-row .btn-ghost {
      width: 100%;
    }

    @media (min-width: 769px) {
      .fw-sheet, .fw-fab { display: none !important; }
    }
  </style>
</head>

<body>
  <div id="app">
    <header class="fw-header">
      <div class="fw-header-title">Five Wonders</div>
      <nav class="fw-header-nav">
        <a href="index.html">Home</a>
        <a href="add-place.html">Add</a>
        <a href="edit-places.html">Edit</a>
        <a href="view.html">View</a>
        <a href="about.html">About</a>
      </nav>
    </header>

    <aside id="sidebar">
      <div id="token-section"></div>

      <div class="section-title">Your places</div>
      <div class="small-help">
        Tap a place to edit the title or note, or delete it.
      </div>

      <div id="place-list" class="place-list"></div>
      <div id="sidebar-status" class="small-help" style="margin-top:8px;"></div>
    </aside>

    <main id="main">
      <div class="pill">Edit</div>
      <h1>Edit a saved place</h1>
      <p class="small-help">
        Choose one of your places on the left, update the details, then click <strong>Save changes</strong>.
      </p>

      <div id="edit-panel">
        <p class="empty-state" id="empty-message">
          No place selected yet. Choose one from the list on the left.
        </p>

        <div id="edit-form" style="display:none;">
          <label for="edit-title">Place name</label>
          <input type="text" id="edit-title" />

          <label for="edit-address">Address / description</label>
          <textarea id="edit-address" readonly></textarea>

          <label for="edit-note">Your note</label>
          <textarea id="edit-note"></textarea>

          <div class="row">
            <span id="edit-meta"></span>
          </div>

          <div class="actions">
            <button id="save-changes-btn" class="btn-primary">Save changes</button>
            <button id="delete-btn" class="btn-danger">Delete place</button>
            <button id="cancel-btn" class="btn-ghost">Cancel</button>
          </div>

          <div id="edit-status" class="status-msg"></div>
        </div>
      </div>
    </main>

    <button id="openEditBtn" class="fw-fab" type="button" aria-label="Edit selected place">Edit</button>

    <section id="editSheet" class="fw-sheet fw-sheet--hidden" aria-hidden="true">
      <div class="fw-sheet-handle" id="sheetHandle" title="Tap to collapse/expand"></div>
      <div class="fw-sheet-header">
        <div class="fw-sheet-title">Edit place</div>
        <button id="closeSheetBtn" class="fw-sheet-close" type="button" aria-label="Close">✕</button>
      </div>
      <div class="fw-sheet-content">
        <div id="mobile-edit-panel">
          <p class="empty-state" id="mobile-empty-message">
            No place selected yet. Choose one from the list, then tap <strong>Edit</strong>.
          </p>

          <div id="mobile-edit-form" style="display:none;">
            <label for="m-edit-title">Place name</label>
            <input type="text" id="m-edit-title" />

            <label for="m-edit-address">Address / description</label>
            <textarea id="m-edit-address" readonly></textarea>

            <label for="m-edit-note">Your note</label>
            <textarea id="m-edit-note"></textarea>

            <div class="row">
              <span id="m-edit-meta"></span>
            </div>

            <div class="action-row">
              <button id="m-save-changes-btn" class="btn-primary">Save changes</button>
              <button id="m-delete-btn" class="btn-danger">Delete place</button>
              <button id="m-cancel-btn" class="btn-ghost">Close</button>
              <div id="m-edit-status" class="status-msg"></div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script type="module">
    // ===== Supabase + access model (same as index/add) =====
    const SUPABASE_URL = "https://ekpssonwtztubqfihlqm.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVrcHNzb253dHp0dWJxZmlobHFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1Njg2MjAsImV4cCI6MjA3OTE0NDYyMH0.R1_-ctf-6NsVUJEApf4N591lA9TPRCJQFzhrDVRbr_4";

    const LS_ID = "fw_profile_id";
    const LS_KEY = "fw_api_key";
    const LS_ID_LEGACY = "profile_id";
    const LS_KEY_LEGACY = "api_key";

    const MANAGE_PLACES_URL =
      "https://ekpssonwtztubqfihlqm.supabase.co/functions/v1/manage-places";

    if (!window.supabase) {
      alert("Supabase failed to load. Please refresh.");
      throw new Error("Supabase library not loaded.");
    }

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    window._sb = sb;

    function getStoredApiKey() {
      return localStorage.getItem(LS_KEY) || localStorage.getItem(LS_KEY_LEGACY);
    }

    function persistKeys(id, apiKey) {
      localStorage.setItem(LS_ID, id);
      localStorage.setItem(LS_KEY, apiKey);
      localStorage.setItem(LS_ID_LEGACY, id);
      localStorage.setItem(LS_KEY_LEGACY, apiKey);
    }

    function resetAccess() {
      localStorage.removeItem(LS_ID);
      localStorage.removeItem(LS_KEY);
      localStorage.removeItem(LS_ID_LEGACY);
      localStorage.removeItem(LS_KEY_LEGACY);
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // ===== Token section UI =====
    async function renderTokenSection() {
      const container = document.getElementById("token-section");
      container.innerHTML = "";

      const apiKey = getStoredApiKey();

      // If we have a key, validate it
      if (apiKey) {
        try {
          const { data, error } = await sb.rpc("validate_api_key", { p_key: apiKey });
          if (!error && data && data.length > 0) {
            persistKeys(data[0].id, apiKey);

            const div = document.createElement("div");
            div.className = "small-help";
            div.innerHTML = `
              Access is set on this device.
              <a href="#" id="resetAccessLink" style="margin-left:8px;">Reset</a>
            `;
            container.appendChild(div);

            document.getElementById("resetAccessLink").onclick = (e) => {
              e.preventDefault();
              resetAccess();
              clearEditor();
              userPlaces = [];
              renderPlaceList();
              document.getElementById("sidebar-status").textContent = "Set invite code to load places.";
              renderTokenSection();
            };

            return true;
          }
        } catch (_) {}
        resetAccess();
      }

      // No key
      const div = document.createElement("div");
      div.className = "token-warning";
      div.innerHTML = `
        <strong>Invite code required</strong><br/>
        Enter your 8-character invite code once. It will be remembered on this device.
        <div style="margin-top:10px;">
          <input type="text" id="invite-input" placeholder="AJWRRHFN" style="width:100%;margin-top:6px;text-transform:uppercase;letter-spacing:0.12em;" />
          <button id="invite-save-btn" class="btn-primary" style="margin-top:10px;">Save invite code</button>
        </div>
      `;
      container.appendChild(div);

      document.getElementById("invite-save-btn").onclick = async () => {
        const value = (document.getElementById("invite-input").value || "")
          .trim()
          .toUpperCase()
          .replace(/[\s-]/g, "");

        if (!value) {
          alert("Please enter the invite code you were given.");
          return;
        }

        try {
          const { data, error } = await sb.rpc("validate_invite", { p_code: value });
          if (error) throw error;
          if (!data || data.length === 0) {
            alert("Invalid invite code.");
            return;
          }

          const row = data[0];
          persistKeys(row.id, row.api_key);

          // load places now that access is set
          await renderTokenSection();
          await loadUserPlaces();
        } catch (e) {
          console.error("validate_invite failed:", e);
          alert("Could not validate invite code.");
        }
      };

      return false;
    }

    // ===== Existing edit logic (unchanged except for token usage) =====
    let userPlaces = [];
    let activePlaceId = null;

    const placeListEl = document.getElementById("place-list");
    const sidebarStatusEl = document.getElementById("sidebar-status");

    const emptyMessageEl = document.getElementById("empty-message");
    const editFormEl = document.getElementById("edit-form");
    const editTitleInput = document.getElementById("edit-title");
    const editAddressInput = document.getElementById("edit-address");
    const editNoteInput = document.getElementById("edit-note");
    const editMetaEl = document.getElementById("edit-meta");
    const editStatusEl = document.getElementById("edit-status");
    const saveChangesBtn = document.getElementById("save-changes-btn");
    const deleteBtn = document.getElementById("delete-btn");
    const cancelBtn = document.getElementById("cancel-btn");

    const openEditBtn = document.getElementById("openEditBtn");
    const editSheet = document.getElementById("editSheet");
    const closeSheetBtn = document.getElementById("closeSheetBtn");
    const sheetHandle = document.getElementById("sheetHandle");

    const mEmptyMessageEl = document.getElementById("mobile-empty-message");
    const mEditFormEl = document.getElementById("mobile-edit-form");
    const mEditTitleInput = document.getElementById("m-edit-title");
    const mEditAddressInput = document.getElementById("m-edit-address");
    const mEditNoteInput = document.getElementById("m-edit-note");
    const mEditMetaEl = document.getElementById("m-edit-meta");
    const mEditStatusEl = document.getElementById("m-edit-status");
    const mSaveBtn = document.getElementById("m-save-changes-btn");
    const mDeleteBtn = document.getElementById("m-delete-btn");
    const mCancelBtn = document.getElementById("m-cancel-btn");

    function isMobile() {
      return window.matchMedia("(max-width: 768px)").matches;
    }

    function openSheet(mode = "open") {
      if (!editSheet) return;
      editSheet.classList.remove("fw-sheet--hidden", "fw-sheet--peek", "fw-sheet--open");
      editSheet.classList.add(mode === "peek" ? "fw-sheet--peek" : "fw-sheet--open");
      editSheet.setAttribute("aria-hidden", "false");
    }

    function closeSheet() {
      if (!editSheet) return;
      editSheet.classList.remove("fw-sheet--open", "fw-sheet--peek");
      editSheet.classList.add("fw-sheet--hidden");
      editSheet.setAttribute("aria-hidden", "true");
    }

    function togglePeek() {
      if (!editSheet) return;
      if (editSheet.classList.contains("fw-sheet--open")) openSheet("peek");
      else openSheet("open");
    }

    function setMobileFabEnabled(enabled) {
      if (!openEditBtn) return;
      openEditBtn.disabled = !enabled;
      openEditBtn.style.opacity = enabled ? "1" : "0.55";
      openEditBtn.style.pointerEvents = enabled ? "auto" : "none";
    }

    function renderPlaceList() {
      placeListEl.innerHTML = "";

      if (!userPlaces || userPlaces.length === 0) {
        placeListEl.innerHTML =
          '<div class="small-help" style="padding:10px 12px;">No places found for this invite code yet.</div>';
        setMobileFabEnabled(false);
        return;
      }

      setMobileFabEnabled(!!activePlaceId);

      userPlaces.forEach((p) => {
        const row = document.createElement("div");
        row.className = "place-row" + (p.id === activePlaceId ? " active" : "");
        row.dataset.id = p.id;

        const title = p.title || "(Untitled place)";
        const note = p.notes || "";

        row.innerHTML = `
          <div class="place-row-title">${escapeHtml(title)}</div>
          ${note ? `<div class="place-row-note">${escapeHtml(note)}</div>` : ""}
        `;

        row.onclick = () => selectPlace(p.id);

        placeListEl.appendChild(row);
      });
    }

    function populateEditor(place) {
      if (emptyMessageEl && editFormEl) {
        emptyMessageEl.style.display = "none";
        editFormEl.style.display = "block";
        editTitleInput.value = place.title || "";
        editAddressInput.value = place.raw_text || "";
        editNoteInput.value = place.notes || "";

        if (place.created_at) {
          const d = new Date(place.created_at);
          editMetaEl.textContent = "Created: " + d.toLocaleString();
        } else {
          editMetaEl.textContent = "";
        }
        editStatusEl.textContent = "";
      }

      if (mEmptyMessageEl && mEditFormEl) {
        mEmptyMessageEl.style.display = "none";
        mEditFormEl.style.display = "block";
        mEditTitleInput.value = place.title || "";
        mEditAddressInput.value = place.raw_text || "";
        mEditNoteInput.value = place.notes || "";

        if (place.created_at) {
          const d = new Date(place.created_at);
          mEditMetaEl.textContent = "Created: " + d.toLocaleString();
        } else {
          mEditMetaEl.textContent = "";
        }
        mEditStatusEl.textContent = "";
      }
    }

    function clearEditor() {
      activePlaceId = null;
      renderPlaceList();

      if (editFormEl && emptyMessageEl) {
        editFormEl.style.display = "none";
        emptyMessageEl.style.display = "block";
      }
      if (editStatusEl) editStatusEl.textContent = "";

      if (mEditFormEl && mEmptyMessageEl) {
        mEditFormEl.style.display = "none";
        mEmptyMessageEl.style.display = "block";
      }
      if (mEditStatusEl) mEditStatusEl.textContent = "";
      setMobileFabEnabled(false);
    }

    function selectPlace(placeId) {
      const place = userPlaces.find((p) => p.id === placeId);
      if (!place) return;

      activePlaceId = placeId;
      renderPlaceList();
      populateEditor(place);
      setMobileFabEnabled(true);
    }

    cancelBtn?.addEventListener("click", clearEditor);

    openEditBtn?.addEventListener("click", () => {
      if (!activePlaceId) return;
      openSheet("open");
    });

    closeSheetBtn?.addEventListener("click", closeSheet);
    sheetHandle?.addEventListener("click", togglePeek);
    mCancelBtn?.addEventListener("click", closeSheet);

    async function loadUserPlaces() {
      const apiKey = getStoredApiKey();
      if (!apiKey) {
        sidebarStatusEl.textContent = "Set your invite code to load places.";
        return;
      }

      sidebarStatusEl.textContent = "Loading places…";

      try {
        const res = await fetch(MANAGE_PLACES_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "list", user_token: apiKey }),
        });

        const text = await res.text();
        if (!res.ok) {
          console.error("Error response from manage-places (list):", res.status, text);
          sidebarStatusEl.textContent = "Error loading places.";
          return;
        }

        let data = {};
        try { data = JSON.parse(text); }
        catch (err) { console.error("JSON parse error from manage-places list:", err, text); }

        userPlaces = Array.isArray(data.places) ? data.places : [];
        activePlaceId = null;
        renderPlaceList();
        sidebarStatusEl.textContent = "";
        clearEditor();
      } catch (err) {
        console.error("Network error loading places:", err);
        sidebarStatusEl.textContent = "Error loading places.";
      }
    }

    async function saveChangesCommon({ title, notes, statusEl }) {
      if (!activePlaceId) return;

      const apiKey = getStoredApiKey();
      if (!apiKey) {
        alert("Missing invite code.");
        return;
      }

      statusEl.textContent = "Saving changes…";

      try {
        const res = await fetch(MANAGE_PLACES_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "update",
            user_token: apiKey,
            place_id: activePlaceId,
            title,
            notes,
          }),
        });

        const text = await res.text();
        if (!res.ok) {
          console.error("Error response from manage-places (update):", res.status, text);
          statusEl.textContent = "Error saving changes.";
          return;
        }

        let data = {};
        try { data = JSON.parse(text); }
        catch (err) { console.error("JSON parse error from manage-places update:", err, text); }

        if (data.status === "ok") {
          const idx = userPlaces.findIndex((p) => p.id === activePlaceId);
          if (idx !== -1) {
            userPlaces[idx].title = title;
            userPlaces[idx].notes = notes;
          }
          renderPlaceList();
          statusEl.textContent = "Changes saved.";
        } else {
          statusEl.textContent = "Error saving changes.";
        }
      } catch (err) {
        console.error("Network error saving changes:", err);
        statusEl.textContent = "Error saving changes.";
      }
    }

    async function deletePlaceCommon({ statusEl, afterDeleteCloseSheet = false }) {
      if (!activePlaceId) return;

      const apiKey = getStoredApiKey();
      if (!apiKey) {
        alert("Missing invite code.");
        return;
      }

      if (!confirm("Delete this place? This cannot be undone.")) return;

      statusEl.textContent = "Deleting…";

      try {
        const res = await fetch(MANAGE_PLACES_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "delete",
            user_token: apiKey,
            place_id: activePlaceId,
          }),
        });

        const text = await res.text();
        if (!res.ok) {
          console.error("Error response from manage-places (delete):", res.status, text);
          statusEl.textContent = "Error deleting place.";
          return;
        }

        let data = {};
        try { data = JSON.parse(text); }
        catch (err) { console.error("JSON parse error from manage-places delete:", err, text); }

        if (data.status === "ok") {
          userPlaces = userPlaces.filter((p) => p.id !== activePlaceId);
          activePlaceId = null;
          renderPlaceList();

          if (editFormEl) editFormEl.style.display = "none";
          if (emptyMessageEl) emptyMessageEl.style.display = "block";
          if (editStatusEl) editStatusEl.textContent = "Place deleted.";

          if (mEditFormEl) mEditFormEl.style.display = "none";
          if (mEmptyMessageEl) mEmptyMessageEl.style.display = "block";
          if (mEditStatusEl) mEditStatusEl.textContent = "Place deleted.";

          setMobileFabEnabled(false);
          if (afterDeleteCloseSheet) closeSheet();
        } else {
          statusEl.textContent = "Error deleting place.";
        }
      } catch (err) {
        console.error("Network error deleting place:", err);
        statusEl.textContent = "Error deleting place.";
      }
    }

    saveChangesBtn?.addEventListener("click", () => {
      saveChangesCommon({
        title: (editTitleInput.value || "").trim(),
        notes: (editNoteInput.value || "").trim(),
        statusEl: editStatusEl,
      }).catch((err) => {
        console.error("Unexpected save error:", err);
        editStatusEl.textContent = "Unexpected error – see console.";
      });
    });

    deleteBtn?.addEventListener("click", () => {
      deletePlaceCommon({ statusEl: editStatusEl }).catch((err) => {
        console.error("Unexpected delete error:", err);
        editStatusEl.textContent = "Unexpected error – see console.";
      });
    });

    mSaveBtn?.addEventListener("click", () => {
      saveChangesCommon({
        title: (mEditTitleInput.value || "").trim(),
        notes: (mEditNoteInput.value || "").trim(),
        statusEl: mEditStatusEl,
      }).catch((err) => {
        console.error("Unexpected save error:", err);
        mEditStatusEl.textContent = "Unexpected error – see console.";
      });
    });

    mDeleteBtn?.addEventListener("click", () => {
      deletePlaceCommon({ statusEl: mEditStatusEl, afterDeleteCloseSheet: true }).catch((err) => {
        console.error("Unexpected delete error:", err);
        mEditStatusEl.textContent = "Unexpected error – see console.";
      });
    });

    // ===== Init =====
    const hasAccess = await renderTokenSection();
    if (hasAccess) {
      loadUserPlaces();
    } else {
      sidebarStatusEl.textContent = "Set invite code to load places.";
      renderPlaceList();
      clearEditor();
    }

    window.addEventListener("resize", () => {
      if (!isMobile()) closeSheet();
    });
  </script>
</body>
</html>
