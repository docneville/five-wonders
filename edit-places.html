<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Edit Places – Five Wonders</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Shared styles -->
  <link rel="stylesheet" href="fw.css" />

  <style>
    /* Saving overlay styles */
    .saving-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
    }
    .saving-overlay.visible {
      opacity: 1;
      visibility: visible;
    }
    .saving-overlay-content {
      background: #fff;
      padding: 24px 32px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 16px;
      font-weight: 500;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }
    .saving-overlay.success .saving-overlay-content {
      background: #e6f9e6;
    }
    .spinner {
      width: 22px;
      height: 22px;
      border: 3px solid #ccc;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .saving-overlay .checkmark {
      color: #22c55e;
      font-size: 24px;
    }
  </style>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <div id="app" class="fw-app-split fw-edit-mobile-list">
    <header class="fw-header">
      <div class="fw-header-title">Five Wonders</div>
      <nav class="fw-header-nav">
        <a href="index.html">Home</a>
        <a href="add-place.html">Add</a>
        <a href="edit-places.html">Edit</a>
        <a href="view.html">View</a>
        <a href="about.html">About</a>
      </nav>
    </header>

    <!-- Left column: list + token banner (token banner is LAST) -->
    <aside id="sidebar" class="fw-sidebar">
      <div class="section-title">Your places</div>
      <div class="small-help">
        Tap a place to edit its details or delete it.
      </div>

      <div id="place-list" class="place-list"></div>
      <div id="sidebar-status" class="small-help" style="margin-top:8px;"></div>

      <!-- Access / invite-code UI is at the bottom now -->
      <div id="token-section" style="margin-top:16px;"></div>
    </aside>

    <!-- Right column: desktop edit form -->
    <main id="main" class="fw-main">
      <div class="pill">Edit</div>
      <h1>Edit a saved place</h1>
      <p class="small-help">
        Choose one of your places on the left, update the details, then click
        <strong>Save changes</strong>.
      </p>

      <div id="edit-panel">
        <p class="empty-state" id="empty-message">
          No place selected yet. Choose one from the list on the left.
        </p>

        <div id="edit-form" style="display:none;">
          <label for="edit-title">Place name</label>
          <input type="text" id="edit-title" />

          <label for="edit-street1">Street line 1</label>
          <input type="text" id="edit-street1" />

          <label for="edit-street2">Street line 2 (optional)</label>
          <input type="text" id="edit-street2" />

          <label for="edit-city">City</label>
          <input type="text" id="edit-city" />

          <label for="edit-state">State / region</label>
          <input type="text" id="edit-state" />

          <label for="edit-postal">Postal code</label>
          <input type="text" id="edit-postal" />

          <label for="edit-country">Country</label>
          <input type="text" id="edit-country" />

          <label for="edit-phone">Phone</label>
          <input type="text" id="edit-phone" />

          <label for="edit-website">Website</label>
          <input type="text" id="edit-website" />

          <label for="edit-note">Why is this a Wonder?</label>
          <textarea id="edit-note"></textarea>

          <label for="edit-category">Category</label>
          <select id="edit-category">
            <option value="Other">Other</option>
            <option value="Dining">Dining</option>
            <option value="Lodging">Lodging</option>
            <option value="Attraction">Attraction</option>
            <option value="Recreation">Recreation</option>
            <option value="Shopping">Shopping</option>
          </select>

          <!-- Links Section -->
          <div class="links-section">
            <label>Links (up to 3)</label>
            <div id="links-container" class="links-container"></div>
            <button type="button" id="add-link-btn" class="btn-ghost add-link-btn">+ Add link</button>
          </div>

          <!-- Photos Section -->
          <div class="photos-section">
            <label>Photos (up to 5)</label>
            <div id="photos-grid" class="photos-grid"></div>
            <div class="photo-upload-area">
              <input type="file" id="photo-input" accept="image/*" multiple style="display:none;" />
              <button type="button" id="add-photo-btn" class="btn-ghost add-photo-btn">+ Add photos</button>
            </div>
            <div id="upload-progress" class="upload-progress" style="display:none;">
              <div class="upload-progress-bar"></div>
              <span class="upload-progress-text">Uploading...</span>
            </div>
          </div>

          <div class="actions edit-actions">
            <button id="save-changes-btn" class="btn-primary">Save changes</button>
            <button id="delete-btn" class="btn-danger">Delete place</button>
            <button id="cancel-btn" class="btn-ghost">Cancel</button>
          </div>

          <div id="edit-status" class="status-msg"></div>

          <div class="edit-meta-section">
            <span id="edit-meta"></span>
          </div>
        </div>
      </div>
    </main>

    <!-- Mobile bottom sheet for editing -->
    <section
      id="editSheet"
      class="fw-sheet fw-sheet--edit fw-sheet--hidden"
      aria-hidden="true"
    >
      <div
        class="fw-sheet-handle"
        id="sheetHandle"
        title="Tap to collapse/expand"
      ></div>
      <div class="fw-sheet-header">
        <div class="fw-sheet-title">Edit place</div>
        <button
          id="closeSheetBtn"
          class="fw-sheet-close"
          type="button"
          aria-label="Close"
        >
          ✕
        </button>
      </div>
      <div class="fw-sheet-content">
        <div id="mobile-edit-panel">
          <p class="empty-state" id="mobile-empty-message">
            No place selected yet. Choose one from the list to edit it.
          </p>

          <div id="mobile-edit-form" style="display:none;">
            <label for="m-edit-title">Place name</label>
            <input type="text" id="m-edit-title" />

            <label for="m-edit-street1">Street line 1</label>
            <input type="text" id="m-edit-street1" />

            <label for="m-edit-street2">Street line 2 (optional)</label>
            <input type="text" id="m-edit-street2" />

            <label for="m-edit-city">City</label>
            <input type="text" id="m-edit-city" />

            <label for="m-edit-state">State / region</label>
            <input type="text" id="m-edit-state" />

            <label for="m-edit-postal">Postal code</label>
            <input type="text" id="m-edit-postal" />

            <label for="m-edit-country">Country</label>
            <input type="text" id="m-edit-country" />

            <label for="m-edit-phone">Phone</label>
            <input type="text" id="m-edit-phone" />

            <label for="m-edit-website">Website</label>
            <input type="text" id="m-edit-website" />

            <label for="m-edit-note">Why is this a Wonder?</label>
            <textarea id="m-edit-note"></textarea>

            <label for="m-edit-category">Category</label>
            <select id="m-edit-category">
              <option value="Other">Other</option>
              <option value="Dining">Dining</option>
              <option value="Lodging">Lodging</option>
              <option value="Attraction">Attraction</option>
              <option value="Recreation">Recreation</option>
              <option value="Shopping">Shopping</option>
            </select>

            <!-- Links Section (Mobile) -->
            <div class="links-section">
              <label>Links (up to 3)</label>
              <div id="m-links-container" class="links-container"></div>
              <button type="button" id="m-add-link-btn" class="btn-ghost add-link-btn">+ Add link</button>
            </div>

            <!-- Photos Section (Mobile) -->
            <div class="photos-section">
              <label>Photos (up to 5)</label>
              <div id="m-photos-grid" class="photos-grid"></div>
              <div class="photo-upload-area">
                <input type="file" id="m-photo-input" accept="image/*" multiple style="display:none;" />
                <button type="button" id="m-add-photo-btn" class="btn-ghost add-photo-btn">+ Add photos</button>
              </div>
              <div id="m-upload-progress" class="upload-progress" style="display:none;">
                <div class="upload-progress-bar"></div>
                <span class="upload-progress-text">Uploading...</span>
              </div>
            </div>

            <!-- Simple vertical button stack; not sticky -->
            <div class="actions edit-actions" style="display:flex; flex-direction:column; gap:10px;">
              <button id="m-save-changes-btn" class="btn-primary">
                Save changes
              </button>
              <button id="m-delete-btn" class="btn-danger">
                Delete place
              </button>
              <button id="m-cancel-btn" class="btn-ghost">
                Close
              </button>

              <div id="m-edit-status" class="status-msg"></div>
            </div>

            <div class="edit-meta-section">
              <span id="m-edit-meta"></span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Saving overlay (full-screen) -->
    <div id="saving-overlay" class="saving-overlay">
      <div class="saving-overlay-content">
        <div class="spinner"></div>
        <span>Saving...</span>
      </div>
    </div>
  </div>

  <script type="module">
    // ===== Supabase + access model =====
    const SUPABASE_URL = "https://ekpssonwtztubqfihlqm.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVrcHNzb253dHp0dWJxZmlobHFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1Njg2MjAsImV4cCI6MjA3OTE0NDYyMH0.R1_-ctf-6NsVUJEApf4N591lA9TPRCJQFzhrDVRbr_4";

    const LS_ID = "fw_profile_id";
    const LS_KEY = "fw_api_key";
    const LS_ID_LEGACY = "profile_id";
    const LS_KEY_LEGACY = "api_key";

    const MANAGE_PLACES_URL =
      "https://ekpssonwtztubqfihlqm.supabase.co/functions/v1/manage-places";

    if (!window.supabase) {
      alert("Supabase failed to load. Please refresh.");
      throw new Error("Supabase library not loaded.");
    }

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    window._sb = sb;

    function getStoredApiKey() {
      return localStorage.getItem(LS_KEY) || localStorage.getItem(LS_KEY_LEGACY);
    }

    function persistKeys(id, apiKey) {
      localStorage.setItem(LS_ID, id);
      localStorage.setItem(LS_KEY, apiKey);
      localStorage.setItem(LS_ID_LEGACY, id);
      localStorage.setItem(LS_KEY_LEGACY, apiKey);
    }

    function resetAccess() {
      localStorage.removeItem(LS_ID);
      localStorage.removeItem(LS_KEY);
      localStorage.removeItem(LS_ID_LEGACY);
      localStorage.removeItem(LS_KEY_LEGACY);
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // "City, State, Country" for list, falling back to raw_text so it's never empty
    function formatAddressFromPlace(p = {}) {
      const parts = [p.city, p.state, p.country].filter(Boolean);
      if (parts.length > 0) return parts.join(", ");
      // FALLBACK: show raw_text (what you had before)
      return p.raw_text || "";
    }

    // ===== Token section UI (now at bottom) =====
    async function renderTokenSection() {
      const container = document.getElementById("token-section");
      container.innerHTML = "";

      const apiKey = getStoredApiKey();

      if (apiKey) {
        try {
          const { data, error } = await sb.rpc("validate_api_key", {
            p_key: apiKey,
          });
          if (!error && data && data.length > 0) {
            persistKeys(data[0].id, apiKey);

            // Access line at the BOTTOM
            const div = document.createElement("div");
            div.className = "small-help";
            div.style.marginTop = "12px";
            div.innerHTML = `
              Access is set on this device.
              <a href="#" id="resetAccessLink" style="margin-left:8px;">Reset</a>
            `;
            container.appendChild(div);

            document.getElementById("resetAccessLink").onclick = (e) => {
              e.preventDefault();
              resetAccess();
              clearEditor();
              userPlaces = [];
              renderPlaceList();
              document.getElementById("sidebar-status").textContent =
                "Set invite code to load places.";
              renderTokenSection();
            };

            return true;
          }
        } catch (_) {}
        resetAccess();
      }

      // No key
      const div = document.createElement("div");
      div.className = "token-warning";
      div.innerHTML = `
        <strong>Invite code required</strong><br/>
        Enter your 8-character invite code once. It will be remembered on this device.
        <div style="margin-top:10px;">
          <input
            type="text"
            id="invite-input"
            placeholder="AJWRRHFN"
            style="width:100%;margin-top:6px;text-transform:uppercase;letter-spacing:0.12em;"
          />
          <button
            id="invite-save-btn"
            class="btn-primary"
            style="margin-top:10px;"
          >
            Save invite code
          </button>
        </div>
      `;
      container.appendChild(div);

      document.getElementById("invite-save-btn").onclick = async () => {
        const value = (document.getElementById("invite-input").value || "")
          .trim()
          .toUpperCase()
          .replace(/[\s-]/g, "");

        if (!value) {
          alert("Please enter the invite code you were given.");
          return;
        }

        try {
          const { data, error } = await sb.rpc("validate_invite", {
            p_code: value,
          });
          if (error) throw error;
          if (!data || data.length === 0) {
            alert("Invalid invite code.");
            return;
          }

          const row = data[0];
          persistKeys(row.id, row.api_key);

          await renderTokenSection();
          await loadUserPlaces();
        } catch (e) {
          console.error("validate_invite failed:", e);
          alert("Could not validate invite code.");
        }
      };

      return false;
    }

    // ===== Edit logic =====
    let userPlaces = [];
    let activePlaceId = null;

    const placeListEl = document.getElementById("place-list");
    const sidebarStatusEl = document.getElementById("sidebar-status");

    const emptyMessageEl = document.getElementById("empty-message");
    const editFormEl = document.getElementById("edit-form");
    const editTitleInput = document.getElementById("edit-title");
    const editNoteInput = document.getElementById("edit-note");
    const editMetaEl = document.getElementById("edit-meta");
    const editStatusEl = document.getElementById("edit-status");

    const editStreet1Input = document.getElementById("edit-street1");
    const editStreet2Input = document.getElementById("edit-street2");
    const editCityInput = document.getElementById("edit-city");
    const editStateInput = document.getElementById("edit-state");
    const editPostalInput = document.getElementById("edit-postal");
    const editCountryInput = document.getElementById("edit-country");
    const editPhoneInput = document.getElementById("edit-phone");
    const editWebsiteInput = document.getElementById("edit-website");
    const editCategorySelect = document.getElementById("edit-category");

    const saveChangesBtn = document.getElementById("save-changes-btn");
    const deleteBtn = document.getElementById("delete-btn");
    const cancelBtn = document.getElementById("cancel-btn");

    const editSheet = document.getElementById("editSheet");
    const closeSheetBtn = document.getElementById("closeSheetBtn");
    const sheetHandle = document.getElementById("sheetHandle");

    // Mobile editor fields
    const mEmptyMessageEl = document.getElementById("mobile-empty-message");
    const mEditFormEl = document.getElementById("mobile-edit-form");
    const mEditTitleInput = document.getElementById("m-edit-title");
    const mEditNoteInput = document.getElementById("m-edit-note");
    const mEditMetaEl = document.getElementById("m-edit-meta");
    const mEditStatusEl = document.getElementById("m-edit-status");

    const mEditStreet1Input = document.getElementById("m-edit-street1");
    const mEditStreet2Input = document.getElementById("m-edit-street2");
    const mEditCityInput = document.getElementById("m-edit-city");
    const mEditStateInput = document.getElementById("m-edit-state");
    const mEditPostalInput = document.getElementById("m-edit-postal");
    const mEditCountryInput = document.getElementById("m-edit-country");
    const mEditPhoneInput = document.getElementById("m-edit-phone");
    const mEditWebsiteInput = document.getElementById("m-edit-website");
    const mEditCategorySelect = document.getElementById("m-edit-category");

    const mSaveBtn = document.getElementById("m-save-changes-btn");
    const mDeleteBtn = document.getElementById("m-delete-btn");
    const mCancelBtn = document.getElementById("m-cancel-btn");

    // Saving overlay element
    const savingOverlay = document.getElementById("saving-overlay");

    // Links elements
    const linksContainer = document.getElementById("links-container");
    const addLinkBtn = document.getElementById("add-link-btn");
    const mLinksContainer = document.getElementById("m-links-container");
    const mAddLinkBtn = document.getElementById("m-add-link-btn");

    // Photos elements
    const photosGrid = document.getElementById("photos-grid");
    const photoInput = document.getElementById("photo-input");
    const addPhotoBtn = document.getElementById("add-photo-btn");
    const uploadProgress = document.getElementById("upload-progress");

    const mPhotosGrid = document.getElementById("m-photos-grid");
    const mPhotoInput = document.getElementById("m-photo-input");
    const mAddPhotoBtn = document.getElementById("m-add-photo-btn");
    const mUploadProgress = document.getElementById("m-upload-progress");

    // Supabase storage URL for photos
    const STORAGE_URL = `${SUPABASE_URL}/storage/v1/object/public/place-photos`;

    // ===== Links Functions =====
    function createLinkEntryHtml(link = {}, index = 0) {
      const url = escapeHtml(link.url || "");
      const text = escapeHtml(link.text || "");
      const description = escapeHtml(link.description || "");
      return `
        <div class="link-entry" data-index="${index}">
          <input type="url" class="link-url" placeholder="https://example.com" value="${url}" />
          <input type="text" class="link-text" placeholder="Link text" value="${text}" />
          <input type="text" class="link-description" placeholder="Description (optional)" value="${description}" />
          <button type="button" class="link-remove-btn btn-ghost" title="Remove link">✕</button>
        </div>
      `;
    }

    function renderLinks(links, container, addBtn) {
      if (!container) return;
      container.innerHTML = "";
      const linksArray = Array.isArray(links) ? links : [];
      linksArray.forEach((link, i) => {
        container.insertAdjacentHTML("beforeend", createLinkEntryHtml(link, i));
      });

      // Update add button state
      if (addBtn) {
        addBtn.disabled = linksArray.length >= 3;
        addBtn.style.opacity = linksArray.length >= 3 ? "0.5" : "1";
      }

      // Attach remove handlers
      container.querySelectorAll(".link-remove-btn").forEach((btn) => {
        btn.onclick = () => {
          if (confirm("Remove this link?")) {
            btn.closest(".link-entry").remove();
            updateAddLinkButtonState(container, addBtn);
          }
        };
      });
    }

    function updateAddLinkButtonState(container, addBtn) {
      if (!addBtn || !container) return;
      const count = container.querySelectorAll(".link-entry").length;
      addBtn.disabled = count >= 3;
      addBtn.style.opacity = count >= 3 ? "0.5" : "1";
    }

    function addLinkEntry(container, addBtn) {
      if (!container) return;
      const count = container.querySelectorAll(".link-entry").length;
      if (count >= 3) return;

      container.insertAdjacentHTML("beforeend", createLinkEntryHtml({}, count));
      updateAddLinkButtonState(container, addBtn);

      // Attach remove handler to new entry
      const entries = container.querySelectorAll(".link-entry");
      const lastEntry = entries[entries.length - 1];
      lastEntry.querySelector(".link-remove-btn").onclick = () => {
        if (confirm("Remove this link?")) {
          lastEntry.remove();
          updateAddLinkButtonState(container, addBtn);
        }
      };
    }

    function collectLinksFromUI(container) {
      if (!container) return [];
      const links = [];
      container.querySelectorAll(".link-entry").forEach((entry) => {
        const url = (entry.querySelector(".link-url").value || "").trim();
        const text = (entry.querySelector(".link-text").value || "").trim();
        const description = (entry.querySelector(".link-description").value || "").trim();
        if (url) {
          links.push({ url, text: text || url, description });
        }
      });
      return links;
    }

    // Attach add link button handlers
    addLinkBtn?.addEventListener("click", () => addLinkEntry(linksContainer, addLinkBtn));
    mAddLinkBtn?.addEventListener("click", () => addLinkEntry(mLinksContainer, mAddLinkBtn));

    // ===== Photos Functions =====
    function getPhotoUrl(storagePath) {
      if (!storagePath) return "";
      return `${STORAGE_URL}/${storagePath}`;
    }

    function renderPhotos(photos, container, isMobileView = false) {
      if (!container) return;
      container.innerHTML = "";
      const photosArray = Array.isArray(photos) ? photos : [];

      if (photosArray.length === 0) {
        container.innerHTML = '<div class="photos-empty small-help">No photos yet</div>';
        return;
      }

      photosArray.forEach((photo) => {
        const thumbUrl = photo.thumbnail_path
          ? getPhotoUrl(photo.thumbnail_path)
          : getPhotoUrl(photo.storage_path);
        const desc = escapeHtml(photo.description || "");

        const photoHtml = `
          <div class="photo-item" data-photo-id="${photo.id}">
            <img src="${thumbUrl}" alt="${desc}" class="photo-thumb" loading="lazy" />
            <div class="photo-actions">
              <button type="button" class="photo-edit-btn" title="Edit description">✎</button>
              <button type="button" class="photo-delete-btn" title="Delete photo">✕</button>
            </div>
            ${desc ? `<div class="photo-description">${desc}</div>` : ""}
          </div>
        `;
        container.insertAdjacentHTML("beforeend", photoHtml);
      });

      // Update add photo button state
      const addBtn = isMobileView ? mAddPhotoBtn : addPhotoBtn;
      if (addBtn) {
        addBtn.disabled = photosArray.length >= 5;
        addBtn.style.opacity = photosArray.length >= 5 ? "0.5" : "1";
      }

      // Attach handlers
      container.querySelectorAll(".photo-delete-btn").forEach((btn) => {
        btn.onclick = async () => {
          const photoItem = btn.closest(".photo-item");
          const photoId = photoItem.dataset.photoId;
          if (confirm("Delete this photo?")) {
            await deletePhoto(photoId, activePlaceId, isMobileView);
          }
        };
      });

      container.querySelectorAll(".photo-edit-btn").forEach((btn) => {
        btn.onclick = async () => {
          const photoItem = btn.closest(".photo-item");
          const photoId = photoItem.dataset.photoId;
          const currentDesc = photoItem.querySelector(".photo-description")?.textContent || "";
          const newDesc = prompt("Photo description:", currentDesc);
          if (newDesc !== null && newDesc !== currentDesc) {
            await updatePhotoDescription(photoId, activePlaceId, newDesc, isMobileView);
          }
        };
      });
    }

    async function generateThumbnail(file, maxWidth = 400) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement("canvas");
            const ratio = maxWidth / img.width;
            canvas.width = maxWidth;
            canvas.height = img.height * ratio;

            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            canvas.toBlob(
              (blob) => {
                const thumbReader = new FileReader();
                thumbReader.onloadend = () => {
                  const base64 = thumbReader.result.split(",")[1];
                  resolve(base64);
                };
                thumbReader.readAsDataURL(blob);
              },
              file.type || "image/jpeg",
              0.8
            );
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    async function uploadPhoto(file, placeId, isMobileView = false) {
      const apiKey = getStoredApiKey();
      if (!apiKey || !placeId) return null;

      const progressEl = isMobileView ? mUploadProgress : uploadProgress;

      try {
        // Show progress
        if (progressEl) {
          progressEl.style.display = "block";
          progressEl.querySelector(".upload-progress-text").textContent = "Preparing...";
        }

        // Read file as base64
        const fileBase64 = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result.split(",")[1]);
          reader.readAsDataURL(file);
        });

        // Generate thumbnail
        if (progressEl) {
          progressEl.querySelector(".upload-progress-text").textContent = "Creating thumbnail...";
        }
        const thumbnailBase64 = await generateThumbnail(file);

        // Upload via edge function
        if (progressEl) {
          progressEl.querySelector(".upload-progress-text").textContent = "Uploading...";
        }

        const res = await fetch(MANAGE_PLACES_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "upload_photo",
            user_token: apiKey,
            place_id: placeId,
            file_base64: fileBase64,
            file_name: file.name,
            file_type: file.type,
            thumbnail_base64: thumbnailBase64,
          }),
        });

        const data = await res.json();

        if (progressEl) {
          progressEl.style.display = "none";
        }

        if (!res.ok || data.error) {
          alert(data.error || "Upload failed");
          return null;
        }

        return data.photo;
      } catch (err) {
        console.error("Upload error:", err);
        if (progressEl) {
          progressEl.style.display = "none";
        }
        alert("Upload failed – see console.");
        return null;
      }
    }

    async function deletePhoto(photoId, placeId, isMobileView = false) {
      const apiKey = getStoredApiKey();
      if (!apiKey || !photoId || !placeId) return;

      try {
        const res = await fetch(MANAGE_PLACES_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "delete_photo",
            user_token: apiKey,
            photo_id: photoId,
            place_id: placeId,
          }),
        });

        const data = await res.json();
        if (!res.ok || data.error) {
          alert(data.error || "Delete failed");
          return;
        }

        // Refresh photos in place data and UI
        const place = userPlaces.find((p) => p.id === placeId);
        if (place && place.photos) {
          place.photos = place.photos.filter((p) => p.id !== photoId);
          renderPhotos(place.photos, isMobileView ? mPhotosGrid : photosGrid, isMobileView);
        }
      } catch (err) {
        console.error("Delete error:", err);
        alert("Delete failed – see console.");
      }
    }

    async function updatePhotoDescription(photoId, placeId, description, isMobileView = false) {
      const apiKey = getStoredApiKey();
      if (!apiKey || !photoId || !placeId) return;

      try {
        const res = await fetch(MANAGE_PLACES_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "update_photo",
            user_token: apiKey,
            photo_id: photoId,
            place_id: placeId,
            description,
          }),
        });

        const data = await res.json();
        if (!res.ok || data.error) {
          alert(data.error || "Update failed");
          return;
        }

        // Update local data and refresh UI
        const place = userPlaces.find((p) => p.id === placeId);
        if (place && place.photos) {
          const photo = place.photos.find((p) => p.id === photoId);
          if (photo) photo.description = description;
          renderPhotos(place.photos, isMobileView ? mPhotosGrid : photosGrid, isMobileView);
        }
      } catch (err) {
        console.error("Update error:", err);
        alert("Update failed – see console.");
      }
    }

    async function handlePhotoUpload(files, isMobileView = false) {
      if (!activePlaceId) return;

      const place = userPlaces.find((p) => p.id === activePlaceId);
      const currentCount = place?.photos?.length || 0;
      const maxPhotos = 5;

      // Limit files to remaining slots
      const filesToUpload = Array.from(files).slice(0, maxPhotos - currentCount);

      if (filesToUpload.length === 0) {
        alert("Maximum 5 photos per place.");
        return;
      }

      for (const file of filesToUpload) {
        const photo = await uploadPhoto(file, activePlaceId, isMobileView);
        if (photo && place) {
          if (!place.photos) place.photos = [];
          place.photos.push(photo);
        }
      }

      // Refresh UI
      if (place) {
        renderPhotos(place.photos, isMobileView ? mPhotosGrid : photosGrid, isMobileView);
      }
    }

    // Photo input handlers
    addPhotoBtn?.addEventListener("click", () => photoInput?.click());
    photoInput?.addEventListener("change", (e) => {
      if (e.target.files?.length) {
        handlePhotoUpload(e.target.files, false);
        e.target.value = "";
      }
    });

    mAddPhotoBtn?.addEventListener("click", () => mPhotoInput?.click());
    mPhotoInput?.addEventListener("change", (e) => {
      if (e.target.files?.length) {
        handlePhotoUpload(e.target.files, true);
        e.target.value = "";
      }
    });

    // Saving overlay helpers
    function showSavingOverlay() {
      savingOverlay.classList.remove("success");
      savingOverlay.querySelector(".saving-overlay-content").innerHTML =
        '<div class="spinner"></div><span>Saving...</span>';
      savingOverlay.classList.add("visible");
    }

    function showSavedOverlay() {
      savingOverlay.classList.add("success");
      savingOverlay.querySelector(".saving-overlay-content").innerHTML =
        '<span class="checkmark">✓</span><span>Saved!</span>';
    }

    function hideSavingOverlay() {
      savingOverlay.classList.remove("visible", "success");
    }

    function isMobile() {
      return window.matchMedia("(max-width: 768px)").matches;
    }

    function openSheet(mode = "open") {
      if (!editSheet) return;
      editSheet.classList.remove(
        "fw-sheet--hidden",
        "fw-sheet--peek",
        "fw-sheet--open"
      );
      editSheet.classList.add(mode === "peek" ? "fw-sheet--peek" : "fw-sheet--open");
      editSheet.setAttribute("aria-hidden", "false");
    }

    function closeSheet() {
      if (!editSheet) return;
      editSheet.classList.remove("fw-sheet--open", "fw-sheet--peek");
      editSheet.classList.add("fw-sheet--hidden");
      editSheet.setAttribute("aria-hidden", "true");
    }

    function togglePeek() {
      if (!editSheet) return;
      if (editSheet.classList.contains("fw-sheet--open")) openSheet("peek");
      else openSheet("open");
    }

    // FAB removed – keep as no-op so callers are safe
    function setMobileFabEnabled(_enabled) { return; }

    function renderPlaceList() {
      placeListEl.innerHTML = "";

      if (!userPlaces || userPlaces.length === 0) {
        placeListEl.innerHTML =
          '<div class="small-help" style="padding:10px 12px;">No places found for this invite code yet.</div>';
        setMobileFabEnabled(false);
        return;
      }

      setMobileFabEnabled(!!activePlaceId);

      userPlaces.forEach((p) => {
        const row = document.createElement("div");
        row.className = "place-row" + (p.id === activePlaceId ? " active" : "");
        row.dataset.id = p.id;

        const title = p.title || "(Untitled place)";
        const addressLine = formatAddressFromPlace(p);

        row.innerHTML = `
          <div class="place-row-title">${escapeHtml(title)}</div>
          ${
            addressLine
              ? `<div class="place-row-note">${escapeHtml(addressLine)}</div>`
              : ""
          }
        `;

        row.onclick = () => {
          selectPlace(p.id);
          if (isMobile()) openSheet("open");
        };

        placeListEl.appendChild(row);
      });
    }

    function populateEditor(place) {
      // Desktop
      if (emptyMessageEl && editFormEl) {
        emptyMessageEl.style.display = "none";
        editFormEl.style.display = "block";

        editTitleInput.value = place.title ?? "";
        editStreet1Input.value = place.street_line1 ?? "";
        editStreet2Input.value = place.street_line2 ?? "";
        editCityInput.value = place.city ?? "";
        editStateInput.value = place.state ?? "";
        editPostalInput.value = place.postal_code ?? "";
        editCountryInput.value = place.country ?? "";
        editPhoneInput.value = place.phone ?? "";
        editWebsiteInput.value = place.website ?? "";
        editNoteInput.value = place.notes ?? "";
        editCategorySelect.value = place.category ?? "Other";

        // Build metadata text
        let metaHtml = "";
        if (place.created_at) {
          const createdDate = new Date(place.created_at);
          metaHtml += "Created: " + createdDate.toLocaleString();
        }
        if (place.updated_at) {
          const updatedDate = new Date(place.updated_at);
          if (metaHtml) metaHtml += "<br>";
          metaHtml += "Last updated: " + updatedDate.toLocaleString();
        }
        editMetaEl.innerHTML = metaHtml;
        editStatusEl.textContent = "";

        // Render links and photos (desktop)
        renderLinks(place.links || [], linksContainer, addLinkBtn);
        renderPhotos(place.photos || [], photosGrid, false);
      }

      // Mobile
      if (mEmptyMessageEl && mEditFormEl) {
        mEmptyMessageEl.style.display = "none";
        mEditFormEl.style.display = "block";

        mEditTitleInput.value = place.title ?? "";
        mEditStreet1Input.value = place.street_line1 ?? "";
        mEditStreet2Input.value = place.street_line2 ?? "";
        mEditCityInput.value = place.city ?? "";
        mEditStateInput.value = place.state ?? "";
        mEditPostalInput.value = place.postal_code ?? "";
        mEditCountryInput.value = place.country ?? "";
        mEditPhoneInput.value = place.phone ?? "";
        mEditWebsiteInput.value = place.website ?? "";
        mEditNoteInput.value = place.notes ?? "";
        mEditCategorySelect.value = place.category ?? "Other";

        // Build metadata text (mobile)
        let mMetaHtml = "";
        if (place.created_at) {
          const createdDate = new Date(place.created_at);
          mMetaHtml += "Created: " + createdDate.toLocaleString();
        }
        if (place.updated_at) {
          const updatedDate = new Date(place.updated_at);
          if (mMetaHtml) mMetaHtml += "<br>";
          mMetaHtml += "Last updated: " + updatedDate.toLocaleString();
        }
        mEditMetaEl.innerHTML = mMetaHtml;
        mEditStatusEl.textContent = "";

        // Render links and photos (mobile)
        renderLinks(place.links || [], mLinksContainer, mAddLinkBtn);
        renderPhotos(place.photos || [], mPhotosGrid, true);
      }
    }

    function clearEditor() {
      activePlaceId = null;
      renderPlaceList();

      if (editFormEl && emptyMessageEl) {
        editFormEl.style.display = "none";
        emptyMessageEl.style.display = "block";
      }
      if (editStatusEl) editStatusEl.textContent = "";
      editTitleInput.value = "";
      editStreet1Input.value = "";
      editStreet2Input.value = "";
      editCityInput.value = "";
      editStateInput.value = "";
      editPostalInput.value = "";
      editCountryInput.value = "";
      editPhoneInput.value = "";
      editWebsiteInput.value = "";
      editNoteInput.value = "";
      editCategorySelect.value = "Other";
      editMetaEl.textContent = "";

      // Clear links and photos (desktop)
      if (linksContainer) linksContainer.innerHTML = "";
      if (addLinkBtn) {
        addLinkBtn.disabled = false;
        addLinkBtn.style.opacity = "1";
      }
      if (photosGrid) photosGrid.innerHTML = '<div class="photos-empty small-help">No photos yet</div>';
      if (addPhotoBtn) {
        addPhotoBtn.disabled = false;
        addPhotoBtn.style.opacity = "1";
      }

      if (mEditFormEl && mEmptyMessageEl) {
        mEditFormEl.style.display = "none";
        mEmptyMessageEl.style.display = "block";
      }
      if (mEditStatusEl) mEditStatusEl.textContent = "";
      mEditTitleInput.value = "";
      mEditStreet1Input.value = "";
      mEditStreet2Input.value = "";
      mEditCityInput.value = "";
      mEditStateInput.value = "";
      mEditPostalInput.value = "";
      mEditCountryInput.value = "";
      mEditPhoneInput.value = "";
      mEditWebsiteInput.value = "";
      mEditNoteInput.value = "";
      mEditCategorySelect.value = "Other";
      mEditMetaEl.textContent = "";

      // Clear links and photos (mobile)
      if (mLinksContainer) mLinksContainer.innerHTML = "";
      if (mAddLinkBtn) {
        mAddLinkBtn.disabled = false;
        mAddLinkBtn.style.opacity = "1";
      }
      if (mPhotosGrid) mPhotosGrid.innerHTML = '<div class="photos-empty small-help">No photos yet</div>';
      if (mAddPhotoBtn) {
        mAddPhotoBtn.disabled = false;
        mAddPhotoBtn.style.opacity = "1";
      }

      setMobileFabEnabled(false);
    }

    function selectPlace(placeId) {
      const place = userPlaces.find((p) => p.id === placeId);
      if (!place) return;

      activePlaceId = placeId;
      renderPlaceList();
      populateEditor(place);
      setMobileFabEnabled(true);
    }

    cancelBtn?.addEventListener("click", clearEditor);

    closeSheetBtn?.addEventListener("click", closeSheet);
    sheetHandle?.addEventListener("click", togglePeek);
    mCancelBtn?.addEventListener("click", closeSheet);

    async function loadUserPlaces() {
      const apiKey = getStoredApiKey();
      if (!apiKey) {
        sidebarStatusEl.textContent = "Set your invite code to load places.";
        return;
      }

      sidebarStatusEl.textContent = "Loading places…";

      try {
        const res = await fetch(MANAGE_PLACES_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "list", user_token: apiKey }),
        });

        const text = await res.text();
        if (!res.ok) {
          console.error(
            "Error response from manage-places (list):",
            res.status,
            text
          );
          sidebarStatusEl.textContent = "Error loading places.";
          return;
        }

        let data = {};
        try {
          data = JSON.parse(text);
        } catch (err) {
          console.error(
            "JSON parse error from manage-places list:",
            err,
            text
          );
        }

        // NOTE: data.places MUST include:
        // id, title, notes, raw_text, city, state, country,
        // street_line1, street_line2, postal_code, phone, website, created_at,
        // links, photos (links = JSONB array, photos = aggregated from place_photos)
        userPlaces = Array.isArray(data.places) ? data.places : [];
        activePlaceId = null;
        renderPlaceList();
        sidebarStatusEl.textContent = "";
        clearEditor();
      } catch (err) {
        console.error("Network error loading places:", err);
        sidebarStatusEl.textContent = "Error loading places.";
      }
    }

    async function saveChangesCommon({
      title,
      notes,
      phone,
      website,
      street_line1,
      street_line2,
      city,
      state,
      postal_code,
      country,
      category,
      links,
      statusEl,
    }) {
      if (!activePlaceId) return;

      const apiKey = getStoredApiKey();
      if (!apiKey) {
        alert("Missing invite code.");
        return;
      }

      statusEl.textContent = "";
      showSavingOverlay();

      try {
        const res = await fetch(MANAGE_PLACES_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "update",
            user_token: apiKey,
            place_id: activePlaceId,
            title,
            notes,
            phone,
            website,
            street_line1,
            street_line2,
            city,
            state,
            postal_code,
            country,
            category,
            links,
          }),
        });

        const text = await res.text();
        if (!res.ok) {
          console.error(
            "Error response from manage-places (update):",
            res.status,
            text
          );
          hideSavingOverlay();
          statusEl.textContent = "Error saving changes.";
          return;
        }

        let data = {};
        try {
          data = JSON.parse(text);
        } catch (err) {
          console.error(
            "JSON parse error from manage-places update:",
            err,
            text
          );
        }

        if (data.status === "ok") {
          const idx = userPlaces.findIndex((p) => p.id === activePlaceId);
          if (idx !== -1) {
            userPlaces[idx] = {
              ...userPlaces[idx],
              title,
              notes,
              phone,
              website,
              street_line1,
              street_line2,
              city,
              state,
              postal_code,
              country,
              category,
              links,
            };
          }
          renderPlaceList();
          showSavedOverlay();
          setTimeout(() => {
            hideSavingOverlay();
          }, 1500);
        } else {
          hideSavingOverlay();
          statusEl.textContent = "Error saving changes.";
        }
      } catch (err) {
        console.error("Network error saving changes:", err);
        hideSavingOverlay();
        statusEl.textContent = "Error saving changes.";
      }
    }

    async function deletePlaceCommon({
      statusEl,
      afterDeleteCloseSheet = false,
    }) {
      if (!activePlaceId) return;

      const apiKey = getStoredApiKey();
      if (!apiKey) {
        alert("Missing invite code.");
        return;
      }

      if (!confirm("Delete this place? This cannot be undone.")) return;

      statusEl.textContent = "Deleting…";

      try {
        const res = await fetch(MANAGE_PLACES_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "delete",
            user_token: apiKey,
            place_id: activePlaceId,
          }),
        });

        const text = await res.text();
        if (!res.ok) {
          console.error(
            "Error response from manage-places (delete):",
            res.status,
            text
          );
          statusEl.textContent = "Error deleting place.";
          return;
        }

        let data = {};
        try {
          data = JSON.parse(text);
        } catch (err) {
          console.error(
            "JSON parse error from manage-places delete:",
            err,
            text
          );
        }

        if (data.status === "ok") {
          userPlaces = userPlaces.filter((p) => p.id !== activePlaceId);
          activePlaceId = null;
          renderPlaceList();

          if (editFormEl) editFormEl.style.display = "none";
          if (emptyMessageEl) emptyMessageEl.style.display = "block";
          if (editStatusEl) editStatusEl.textContent = "Place deleted.";

          if (mEditFormEl) mEditFormEl.style.display = "none";
          if (mEmptyMessageEl) mEmptyMessageEl.style.display = "block";
          if (mEditStatusEl) mEditStatusEl.textContent = "Place deleted.";

          setMobileFabEnabled(false);
          if (afterDeleteCloseSheet) closeSheet();
        } else {
          statusEl.textContent = "Error deleting place.";
        }
      } catch (err) {
        console.error("Network error deleting place:", err);
        statusEl.textContent = "Error deleting place.";
      }
    }

    // Desktop save
    saveChangesBtn?.addEventListener("click", () => {
      saveChangesCommon({
        title: (editTitleInput.value || "").trim(),
        notes: (editNoteInput.value || "").trim(),
        phone: (editPhoneInput.value || "").trim(),
        website: (editWebsiteInput.value || "").trim(),
        street_line1: (editStreet1Input.value || "").trim(),
        street_line2: (editStreet2Input.value || "").trim(),
        city: (editCityInput.value || "").trim(),
        state: (editStateInput.value || "").trim(),
        postal_code: (editPostalInput.value || "").trim(),
        country: (editCountryInput.value || "").trim(),
        category: editCategorySelect.value || "Other",
        links: collectLinksFromUI(linksContainer),
        statusEl: editStatusEl,
      }).catch((err) => {
        console.error("Unexpected save error:", err);
        hideSavingOverlay();
        editStatusEl.textContent = "Unexpected error – see console.";
      });
    });

    // Desktop delete
    deleteBtn?.addEventListener("click", () => {
      deletePlaceCommon({ statusEl: editStatusEl }).catch((err) => {
        console.error("Unexpected delete error:", err);
        editStatusEl.textContent = "Unexpected error – see console.";
      });
    });

    // Mobile save
    mSaveBtn?.addEventListener("click", () => {
      saveChangesCommon({
        title: (mEditTitleInput.value || "").trim(),
        notes: (mEditNoteInput.value || "").trim(),
        phone: (mEditPhoneInput.value || "").trim(),
        website: (mEditWebsiteInput.value || "").trim(),
        street_line1: (mEditStreet1Input.value || "").trim(),
        street_line2: (mEditStreet2Input.value || "").trim(),
        city: (mEditCityInput.value || "").trim(),
        state: (mEditStateInput.value || "").trim(),
        postal_code: (mEditPostalInput.value || "").trim(),
        country: (mEditCountryInput.value || "").trim(),
        category: mEditCategorySelect.value || "Other",
        links: collectLinksFromUI(mLinksContainer),
        statusEl: mEditStatusEl,
      }).catch((err) => {
        console.error("Unexpected save error:", err);
        hideSavingOverlay();
        mEditStatusEl.textContent = "Unexpected error – see console.";
      });
    });

    // Mobile delete
    mDeleteBtn?.addEventListener("click", () => {
      deletePlaceCommon({
        statusEl: mEditStatusEl,
        afterDeleteCloseSheet: true,
      }).catch((err) => {
        console.error("Unexpected delete error:", err);
        mEditStatusEl.textContent = "Unexpected error – see console.";
      });
    });

    // ===== Init =====
    const hasAccess = await renderTokenSection();
    if (hasAccess) {
      loadUserPlaces();
    } else {
      sidebarStatusEl.textContent = "Set invite code to load places.";
      renderPlaceList();
      clearEditor();
    }

    window.addEventListener("resize", () => {
      if (!isMobile()) closeSheet();
    });
  </script>
</body>
</html>
